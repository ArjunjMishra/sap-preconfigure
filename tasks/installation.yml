---
# tasks file for sap-preconfigure: installation

- name: ensure required package groups are installed
  package:
    state: present
    name: "{{ __sap_preconfigure_packagegroups }}"

- name: ensure required packages are installed
  package:
    state: present
    name: "{{ __sap_preconfigure_packages }}"
  register: sap_preconfigure_register_groupinstall

- name: ensure minimum packages are installed
  block:
    - name: check if minimum release needs to be installed
      shell: |
             set -x
             required_pkg={{ pkg | join('-') }}
             newest=$(echo -e "$required_pkg\n$(rpm -q {{ pkg[0] }} )"| sort -V | tail -1)
             if [ $newest == $required_pkg ]; then
                echo $newest
             fi
      loop: "{{ __sap_preconfigure_min_pkgs }}"
      loop_control:
               loop_var: pkg
      check_mode: no
      register: __sap_preconfigure_register_minpkglist
      changed_when: false

    - name: Initialize an empty list for our strings
      set_fact:
        __sap_preconfigure_fact_minpkglist: []

    - name: Create list of packages to be installed
      set_fact:
        __sap_preconfigure_fact_minpkglist: "{{ __sap_preconfigure_fact_minpkglist | difference(['']) + [ pkg.stdout ] }}"
      loop: "{{ __sap_preconfigure_register_minpkglist.results }}"
      loop_control:
               loop_var: pkg
    - debug: var=__sap_preconfigure_fact_minpkglist

    - name: Install minimum packages if required
      yum:
             name: "{{ __sap_preconfigure_fact_minpkglist }}"
             state: present
      when: not ( __sap_preconfigure_fact_minpkglist == [ "" ] )

  when:
    - sap_preconfigure_min_package_check|bool
    - not( (__sap_preconfigure_min_pkgs is undefined) or (__sap_preconfigure_min_pkgs is none) or (__sap_preconfigure_min_pkgs | trim == '') )

- name: ensure system is updated to the latest patchlevel
  package:
    state: latest
    name: "*"
  when: sap_preconfigure_update
  register: sap_preconfigure_register_packageinstall

...
